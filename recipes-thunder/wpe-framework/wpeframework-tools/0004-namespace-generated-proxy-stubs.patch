*******************************************************************************
From: Thamim Razith <tabbas651@cable.comcast.com>
Date: Tue, 24 Dec 2025 10:53:28 +0000
Subject: [PATCH] Fix namespace qualification issues in generated proxy stubs

Problem:
- Generated proxy stubs contained unqualified ID constants in iterator types
- Missing Exchange:: namespace prefix caused compilation errors like:
  "ID_LOADED_APP_INFO_ITERATOR was not declared in this scope"
- WPEFramework references needed conversion to Thunder namespace

Solution:
- Add automatic post-processing after proxy stub generation
- Use regex to fix namespace qualification in generated files
- Track generated files and apply fixes automatically

Reason for Change:
- Track generated .cpp files during creation
- Apply namespace fixes after all files are generated
- Convert WPEFramework -> Thunder
- Fix iterator type ID qualification: ID_X -> Exchange::ID_X
Signed-off-by: Thamim Razith <tabbas651@cable.comcast.com>
*************************************************************************************
diff --git a/ProxyStubGenerator/StubGenerator.py b/ProxyStubGenerator/StubGenerator.py
index e183af6..1b7790c 100755
--- a/ProxyStubGenerator/StubGenerator.py
+++ b/ProxyStubGenerator/StubGenerator.py
@@ -97,6 +97,56 @@ def Unreachable():
 def CreateName(ns):
     return ns.replace("::I", "").replace("::", "")[1 if ns[0] == "I" else 0:]

+def FixIteratorNamespace(content):
+    """Fix iterator type ID qualification by adding Exchange:: prefix"""
+
+    # First check if there are any unqualified ID constants to fix
+    # Look for ID_ patterns that are NOT already prefixed with Exchange:: or Thunder::Exchange::
+    if not re.search(r'(?<!Exchange::)(?<!Thunder::Exchange::)ID_[A-Z0-9_]+', content):
+        return content  # No unqualified IDs found, skip processing
+
+    # Pattern 1: RPC::IIteratorType<Exchange::Something, ID_SOMETHING>
+    # Replace with: RPC::IIteratorType<Exchange::Something, Thunder::Exchange::ID_SOMETHING>
+    content = re.sub(
+        r'(RPC::IIteratorType<[^,]+,\s*)(?<!Exchange::)(?<!Thunder::Exchange::)(ID_[A-Z0-9_]+)(\s*>)',
+        r'\1Thunder::Exchange::\2\3',
+        content
+    )
+    # Pattern 2: Handle cases where there might be spaces or other patterns
+    content = re.sub(
+        r'(using\s+interface\s*=\s*RPC::IIteratorType<[^,]+,\s*)(?<!Exchange::)(?<!Thunder::Exchange::)(ID_[A-Z0-9_]+)(\s*>)',
+        r'\1Thunder::Exchange::\2\3',
+        content
+    )
+
+    return content
+
+def FixWPEFrameworkNamespace(content):
+    """Convert WPEFramework references to Thunder"""
+    return re.sub(r'\bWPEFramework\b', 'Thunder', content)
+
+def PostProcessGeneratedFile(file_path):
+    """Post-process a generated file to fix namespace issues"""
+    try:
+        with open(file_path, 'r', encoding='utf-8') as f:
+            content = f.read()
+
+        original_content = content
+
+        # Apply fixes
+        content = FixWPEFrameworkNamespace(content)
+        content = FixIteratorNamespace(content)
+
+        if content != original_content:
+            # Write fixed content
+            with open(file_path, 'w', encoding='utf-8') as f:
+                f.write(content)
+            return True
+        return False
+    except Exception as e:
+        print(f"Error post-processing {file_path}: {e}")
+        return False
+
 def Normalize(n):
     return n.replace('.', '_').replace('[','_').replace(']','_').replace("()",'_').replace('(','_').replace(')','_')

@@ -2905,6 +2955,10 @@ if __name__ == "__main__":
                             faces += new_faces
                             log.Info("created file %s" % os.path.basename(output_file))

+                            # Post-process the generated file to fix namespace issues
+                            if PostProcessGeneratedFile(output_file):
+                                log.Info("post-processed %s for namespace fixes" % os.path.basename(output_file))
+
                         # dump interfaces if only scanning
                         if scan_only:
                             for f in sorted(output, key=lambda x: str(x.id)):

