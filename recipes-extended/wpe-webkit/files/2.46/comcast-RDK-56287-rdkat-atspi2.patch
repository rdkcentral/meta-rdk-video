From 5282423102fb8d153dd39f913fd949e621d7c4d6 Mon Sep 17 00:00:00 2001
From: Filipe Norte <filipe_norte@comcast.com>
Date: Wed, 11 Feb 2026 09:41:07 +0000
Subject: [PATCH] comcast - RDK-56287 - TTS support using AT-SPI2

ATK support removed from newer wpe-webkit version

Signed-off-by: Filipe Norte <filipe_norte@comcast.com>
---
 Source/WebCore/PlatformWPE.cmake                 |  4 ++++
 .../accessibility/atspi/AccessibilityAtspi.cpp   |  7 ++++---
 .../accessibility/atspi/AccessibilityAtspi.h     |  1 +
 Source/WebKit/WebProcess/glib/WebProcessGLib.cpp | 16 +++++++++++++++-
 4 files changed, 24 insertions(+), 4 deletions(-)

diff --git a/Source/WebCore/PlatformWPE.cmake b/Source/WebCore/PlatformWPE.cmake
index d133eae89473..f4c115a561d1 100644
--- a/Source/WebCore/PlatformWPE.cmake
+++ b/Source/WebCore/PlatformWPE.cmake
@@ -86,6 +86,10 @@ if (USE_OPENXR)
     list(APPEND WebCore_SYSTEM_INCLUDE_DIRECTORIES ${OPENXR_INCLUDE_DIRS})
 endif ()
 
+if (USE_ATSPI)
+    list(APPEND WebCore_LIBRARIES rdkatatspi2)
+endif ()
+
 if (USE_ATSPI)
     set(WebCore_AtspiInterfaceFiles
         ${WEBCORE_DIR}/accessibility/atspi/xml/Accessible.xml
diff --git a/Source/WebCore/accessibility/atspi/AccessibilityAtspi.cpp b/Source/WebCore/accessibility/atspi/AccessibilityAtspi.cpp
index 636ac222fde3..e46020245749 100644
--- a/Source/WebCore/accessibility/atspi/AccessibilityAtspi.cpp
+++ b/Source/WebCore/accessibility/atspi/AccessibilityAtspi.cpp
@@ -75,14 +75,14 @@ void AccessibilityAtspi::connect(const String& busAddress, const String& busName
 
 void AccessibilityAtspi::didConnect(GRefPtr<GDBusConnection>&& connection)
 {
-    m_connection = WTFMove(connection);
-    if (!m_connection) {
+    m_pendingConnection = WTFMove(connection);
+    if (!m_pendingConnection) {
         m_isConnecting = false;
         return;
     }
 
     RELEASE_ASSERT(g_dbus_is_name(m_busName.utf8().data()));
-    g_bus_own_name_on_connection(m_connection.get(), m_busName.utf8().data(), G_BUS_NAME_OWNER_FLAGS_DO_NOT_QUEUE,
+    g_bus_own_name_on_connection(m_pendingConnection.get(), m_busName.utf8().data(), G_BUS_NAME_OWNER_FLAGS_DO_NOT_QUEUE,
         [](GDBusConnection*, const char*, gpointer userData) {
             auto& atspi = *static_cast<AccessibilityAtspi*>(userData);
             atspi.didOwnName();
@@ -93,6 +93,7 @@ void AccessibilityAtspi::didConnect(GRefPtr<GDBusConnection>&& connection)
 void AccessibilityAtspi::didOwnName()
 {
     m_isConnecting = false;
+    m_connection = WTFMove(m_pendingConnection);
 
     for (auto& pendingRegistration : m_pendingRootRegistrations)
         registerRoot(pendingRegistration.root, WTFMove(pendingRegistration.interfaces), WTFMove(pendingRegistration.completionHandler));
diff --git a/Source/WebCore/accessibility/atspi/AccessibilityAtspi.h b/Source/WebCore/accessibility/atspi/AccessibilityAtspi.h
index 6266eb09b0a8..f15d872042b8 100644
--- a/Source/WebCore/accessibility/atspi/AccessibilityAtspi.h
+++ b/Source/WebCore/accessibility/atspi/AccessibilityAtspi.h
@@ -132,6 +132,7 @@ private:
     String m_busName;
     bool m_isConnecting { false };
     GRefPtr<GDBusConnection> m_connection;
+    GRefPtr<GDBusConnection> m_pendingConnection;
     GRefPtr<GDBusProxy> m_registry;
     Vector<PendingRootRegistration> m_pendingRootRegistrations;
     HashMap<CString, Vector<GUniquePtr<char*>>> m_eventListeners;
diff --git a/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp b/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
index ff543f944a32..50399c5d9b0e 100644
--- a/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
+++ b/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
@@ -100,6 +100,10 @@
 #include <wtf/ASCIICType.h>
 #endif
 
+#if USE(ATSPI)
+#include <rdkat-atspi2.h>
+#endif
+
 #define RELEASE_LOG_SESSION_ID (m_sessionID ? m_sessionID->toUInt64() : 0)
 #define WEBPROCESS_RELEASE_LOG(channel, fmt, ...) RELEASE_LOG(channel, "%p - [sessionID=%" PRIu64 "] WebProcess::" fmt, this, RELEASE_LOG_SESSION_ID, ##__VA_ARGS__)
 #define WEBPROCESS_RELEASE_LOG_ERROR(channel, fmt, ...) RELEASE_LOG_ERROR(channel, "%p - [sessionID=%" PRIu64 "] WebProcess::" fmt, this, RELEASE_LOG_SESSION_ID, ##__VA_ARGS__)
@@ -231,7 +235,17 @@ void WebProcess::platformInitializeWebProcess(WebProcessCreationParameters& para
 #endif
 
 #if USE(ATSPI)
-    AccessibilityAtspi::singleton().connect(parameters.accessibilityBusAddress, parameters.accessibilityBusName);
+    // Enable RDKAT to process WebKit event into real speach (if TTS enabled)
+    WTFLogAlways("Enable RDKAT processing for WPE");
+
+    WebCore::AXObjectCache::enableAccessibility();
+
+    const char * address = RDKAT_Initialize();
+
+    if (!parameters.accessibilityBusAddress.isEmpty())
+        WTFLogAlways("WARNING: Overriding accessibility bus address with address provided by RDKAT");
+
+    AccessibilityAtspi::singleton().connect(String::fromLatin1(address), parameters.accessibilityBusName);
 #endif
 
     if (parameters.disableFontHintingForTesting)
-- 
2.43.0

