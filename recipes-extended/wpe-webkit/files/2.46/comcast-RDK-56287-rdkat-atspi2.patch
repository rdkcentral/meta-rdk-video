From 3058f828ba49733c85c12985c691647b5cbd3f5c Mon Sep 17 00:00:00 2001
From: Andrzej Surdej <Andrzej_Surdej@comcast.com>
Date: Tue, 10 Jun 2025 09:25:51 +0200
Subject: [PATCH] comcast - RDK-56287 - TTS support using AT-SPI2

ATK support removed from newer wpe-webkit version

Signed-off-by: Filipe Norte <filipe_norte@comcast.com>
---
 Source/WebCore/PlatformWPE.cmake                 |  4 ++++
 Source/WebKit/WebProcess/glib/WebProcessGLib.cpp | 14 +++++++++++++-
 2 files changed, 17 insertions(+), 1 deletion(-)

diff --git a/Source/WebCore/PlatformWPE.cmake b/Source/WebCore/PlatformWPE.cmake
index d133eae89473..f4c115a561d1 100644
--- a/Source/WebCore/PlatformWPE.cmake
+++ b/Source/WebCore/PlatformWPE.cmake
@@ -86,6 +86,10 @@ if (USE_OPENXR)
     list(APPEND WebCore_SYSTEM_INCLUDE_DIRECTORIES ${OPENXR_INCLUDE_DIRS})
 endif ()
 
+if (USE_ATSPI)
+    list(APPEND WebCore_LIBRARIES rdkatatspi2)
+endif ()
+
 if (USE_ATSPI)
     set(WebCore_AtspiInterfaceFiles
         ${WEBCORE_DIR}/accessibility/atspi/xml/Accessible.xml
diff --git a/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp b/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
index ff543f944a32..03502c6b565c 100644
--- a/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
+++ b/Source/WebKit/WebProcess/glib/WebProcessGLib.cpp
@@ -100,6 +100,10 @@
 #include <wtf/ASCIICType.h>
 #endif
 
+#if USE(ATSPI)
+#include <rdkat-atspi2.h>
+#endif
+
 #define RELEASE_LOG_SESSION_ID (m_sessionID ? m_sessionID->toUInt64() : 0)
 #define WEBPROCESS_RELEASE_LOG(channel, fmt, ...) RELEASE_LOG(channel, "%p - [sessionID=%" PRIu64 "] WebProcess::" fmt, this, RELEASE_LOG_SESSION_ID, ##__VA_ARGS__)
 #define WEBPROCESS_RELEASE_LOG_ERROR(channel, fmt, ...) RELEASE_LOG_ERROR(channel, "%p - [sessionID=%" PRIu64 "] WebProcess::" fmt, this, RELEASE_LOG_SESSION_ID, ##__VA_ARGS__)
@@ -231,7 +235,15 @@ void WebProcess::platformInitializeWebProcess(WebProcessCreationParameters& para
 #endif
 
 #if USE(ATSPI)
-    AccessibilityAtspi::singleton().connect(parameters.accessibilityBusAddress, parameters.accessibilityBusName);
+    // Enable RDKAT to process WebKit event into real speach (if TTS enabled)
+    WTFLogAlways("Enable RDKAT processing for WPE");
+
+    const char * address = RDKAT_Initialize();
+
+    if (!parameters.accessibilityBusAddress.isEmpty())
+        WTFLogAlways("WARNING: Overriding accessibility bus address with address provided by RDKAT");
+
+    AccessibilityAtspi::singleton().connect(String::fromLatin1(address), parameters.accessibilityBusName);
 #endif
 
     if (parameters.disableFontHintingForTesting)
-- 
2.48.1

