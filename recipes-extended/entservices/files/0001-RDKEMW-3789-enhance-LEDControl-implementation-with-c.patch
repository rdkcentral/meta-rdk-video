From 04891e84fab19f8d44fba541095e474f643f6805 Mon Sep 17 00:00:00 2001
From: Arun Madhavan <arun_madhavan@comcast.com>
Date: Wed, 3 Sep 2025 13:17:09 -0400
Subject: [PATCH] RDKEMW-3789: enhance LEDControl implementation with cache for
 supported state

---
 LEDControl/LEDControlImplementation.cpp | 57 ++++++++++++++++++++++---
 LEDControl/LEDControlImplementation.h   |  1 +
 2 files changed, 51 insertions(+), 7 deletions(-)

diff --git a/LEDControl/LEDControlImplementation.cpp b/LEDControl/LEDControlImplementation.cpp
index 70ab21f..8cf2839 100644
--- a/LEDControl/LEDControlImplementation.cpp
+++ b/LEDControl/LEDControlImplementation.cpp
@@ -33,15 +33,45 @@ namespace WPEFramework
     {
         SERVICE_REGISTRATION(LEDControlImplementation, 1, 0);
 
-        LEDControlImplementation::LEDControlImplementation(): m_isPlatInitialized (false)
+        LEDControlImplementation::LEDControlImplementation()
+        : m_isPlatInitialized(false)
+        , m_SupportedLEDStates((unsigned int)dsFPD_LED_DEVICE_NONE)
         {
             LOGINFO("LEDControlImplementation Constructor called\n");
             if (!m_isPlatInitialized) {
                 LOGINFO("Doing plat init; dsFPInit\n");
-                if (dsERR_NONE != dsFPInit()){
-                    LOGERR("dsFPInit failed\n");
+                try {
+                    dsError_t err = dsERR_NONE;
+                    if ((err = dsFPInit()) != dsERR_NONE) {
+                        LOGERR("dsFPInit failed: %d\n", err);
+                    } else {
+                        m_isPlatInitialized = true;
+                        // Start a worker JOB to update the m_SupportedLEDStates using WPEFramework's worker pool
+                        class UpdateSupportedLEDStatesJob : public Core::IDispatch {
+                        public:
+                            UpdateSupportedLEDStatesJob(LEDControlImplementation* parent) : _parent(parent) {}
+                            void Dispatch() override {
+                                try {
+                                    unsigned int supported = (unsigned int)dsFPD_LED_DEVICE_NONE;
+                                    dsError_t err = dsFPGetSupportedLEDStates(&supported);
+                                    if (err == dsERR_NONE) {
+                                        _parent->m_SupportedLEDStates = supported;
+                                        LOGINFO("Worker m_SupportedLEDStates updated: 0x%X\n", supported);
+                                    } else {
+                                        LOGERR("Worker dsFPGetSupportedLEDStates failed: %d\n", err);
+                                    }
+                                } catch (...) {
+                                    LOGERR("Worker got exception updating m_SupportedLEDStates\n");
+                                }
+                            }
+                        private:
+                            LEDControlImplementation* _parent;
+                        };
+                        Core::IWorkerPool::Instance().Submit(Core::ProxyType<Core::IDispatch>(Core::ProxyType<UpdateSupportedLEDStatesJob>::Create(this)));
+                    }
+                } catch (...) {
+                    LOGERR("Exception caught during dsFPInit");
                 }
-                m_isPlatInitialized = true;
             }
         }
 
@@ -50,10 +80,15 @@ namespace WPEFramework
             LOGINFO("LEDControlImplementation Destructor called\n");
             if (m_isPlatInitialized) {
                 LOGINFO("Doing plat uninit; dsFPTerm\n");
-                if (dsERR_NONE != dsFPTerm()) {
-                    LOGERR("dsFPTerm failed\n");
+                try {
+                    dsError_t err = dsFPTerm();
+                    if (dsERR_NONE != err) {
+                        LOGERR("dsFPTerm failed\n");
+                    }
+                    m_isPlatInitialized = false;
+                } catch (...) {
+                    LOGERR("Exception caught during dsFPTerm");
                 }
-                m_isPlatInitialized = false;
             }
         }
 
@@ -171,6 +206,9 @@ namespace WPEFramework
                     if (dsERR_NONE != err) {
                         LOGERR("dsFPGetSupportedLEDStates error %d\n", err);
                         return getCoreErrorFromDSError(err);
+                    } else {
+                        // Refresh the cached supported LED states
+                        m_SupportedLEDStates = halSupportedLEDStates;
                     }
                 } catch (...) {
                     LOGERR("Exception in dsFPGetSupportedLEDStates.\n");
@@ -233,6 +271,11 @@ namespace WPEFramework
                 LOGERR("Invalid dsFPDLedState_t value: %s\n", e.what());
                 return Core::ERROR_READ_ERROR;
             }
+            // return error if requested state is unsupported
+            if (!(m_SupportedLEDStates & (1 << static_cast<int>(dsLEDState)))) {
+                LOGERR("Requested LED state 0x%X is unsupported, supported states: 0x%X\n", static_cast<int>(state), m_SupportedLEDStates);
+                return Core::ERROR_NOT_SUPPORTED;
+            }
 
             dsError_t err = dsERR_NONE;
             {
diff --git a/LEDControl/LEDControlImplementation.h b/LEDControl/LEDControlImplementation.h
index a406bf0..f2a26e7 100644
--- a/LEDControl/LEDControlImplementation.h
+++ b/LEDControl/LEDControlImplementation.h
@@ -58,6 +58,7 @@ namespace WPEFramework
             private:
                 mutable Core::CriticalSection _adminLock;
                 bool m_isPlatInitialized;
+                unsigned int m_SupportedLEDStates;
         };
     } // namespace Plugin
 } // namespace WPEFramework
-- 
2.34.1.windows.1

