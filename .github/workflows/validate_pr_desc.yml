name: PR Description Validation

on:
  pull_request:
    branches: [develop]
    types: [opened, edited, synchronize]

jobs:
  validate-pr-description:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate PR Description
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        # valid ticket IDs
        VALID_TICKET_IDS=("RDKEMW" "RDKEVD" "IMMUI" "RDKTV" "RDKSTB" "ES1" "XIONE" "SERCOMM")
        
        # Use PR title if body is empty, otherwise use body
        if [ -z "$PR_BODY" ]; then
          DESCRIPTION="$PR_TITLE"
        else
          DESCRIPTION="$PR_BODY"
        fi
        
        echo "Validating PR description: $DESCRIPTION"
        
        # Check if description matches the pattern <TICKETID>-<ticketno.> : <desc>
        if [[ ! "$DESCRIPTION" =~ ^[A-Z0-9]+-[0-9]+[[:space:]]*:[[:space:]]*.+ ]]; then
          echo "ERROR: PR description format is invalid."
          echo "Expected format: <TICKETID>-<ticketno.> : <description>"
          echo "Example: RDKEMW-123 : Fix playback issue"
          echo ""
          echo "Valid ticket IDs are:"
          printf "%s\n" "${VALID_TICKET_IDS[@]}"
          exit 1
        fi
        
        # Extract ticket ID from the description
        TICKET_PREFIX=$(echo "$DESCRIPTION" | sed -n 's/^\([A-Z0-9]\+\)-[0-9]\+[[:space:]]*:.*$/\1/p')
        
        if [ -z "$TICKET_PREFIX" ]; then
          echo "ERROR: Could not extract ticket ID from description."
          echo "Expected format: <TICKETID>-<ticketno.> : <description>"
          echo ""
          echo "Valid ticket IDs are:"
          printf "%s\n" "${VALID_TICKET_IDS[@]}"
          exit 1
        fi
        
        # Check if extracted ticket ID is in the valid list
        VALID=false
        for valid_id in "${VALID_TICKET_IDS[@]}"; do
          if [ "$TICKET_PREFIX" = "$valid_id" ]; then
            VALID=true
            break
          fi
        done
        
        if [ "$VALID" = false ]; then
          echo "ERROR: Invalid ticket ID '$TICKET_PREFIX'"
          echo ""
          echo "Valid ticket IDs are:"
          printf "%s\n" "${VALID_TICKET_IDS[@]}"
          echo ""
          echo "Your PR description should start with one of the above ticket IDs followed by a number."
          echo "Example: RDKEMW-123 : Fix playback issue"
          exit 1
        fi
        
        echo "PR description validation passed!"
        echo "Ticket ID: $TICKET_PREFIX"
